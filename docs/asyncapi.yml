asyncapi: 3.0.0
info:
  title: FCP Farming Data Model (FDM) - Event API
  version: 0.1.0
  description: |
    The FDM service consumes CloudEvents from FCP services via AWS SQS to build
    a centralized data model for farming and countryside programmes.
    
    Events are consumed from `fcp_audit` SQS queue, processed through validation,
    and stored in MongoDB collections for aggregation and querying.
  license:
    name: Open Government Licence v3.0
    url: https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3

defaultContentType: application/json

servers:
  development:
    host: localhost:4566
    protocol: sqs
    description: LocalStack SQS for development
    bindings:
      sqs:
        region: eu-west-2
        queueName: fcp_audit
        deadLetterQueue:
          name: fcp_audit-deadletter
          maxReceiveCount: 3

channels:
  eventQueue:
    address: fcp_audit
    description: Main event queue for FCP Audit events to be processed by the Auditing service.
    messages:
      auditEvent:
        $ref: '#/components/messages/AuditEvent'

operations:
  consumeEvents:
    action: receive
    channel:
      $ref: '#/channels/eventQueue'
    description: |
      Consume and process audit events from the SQS queue. Events are validated,
      stored in the audit collection and optionally published to SOC.
    messages:
      - $ref: '#/channels/eventQueue/messages/auditEvent'

components:
  messages:
    AuditEvent:
      name: AuditEvent
      title: Audit Event
      description: Audit event received by the Auditing service.
      contentType: application/json
      payload:
        $ref: '#/components/schemas/AuditEventPayload'

  schemas:
    AuditEventPayload:
      type: object
      required: [sessionid, correlationid, datetime, environment, version, application, component, ip]
      properties:
        user:
          type: string
          maxLength: 50
          description: User identifier in format IDM/{user-guid} or AAD/{user-guid}. Optional field, can be empty string.
          example: IDM/8b7c6b0a-4ea2-e911-a971-000d3a28d1a0
        sessionid:
          type: string
          maxLength: 50
          description: Session identifier for tracking user session activities
          example: e66d78f5-a58d-46f6-a9b4-f8c90e99b6dc
        correlationid:
          type: string
          maxLength: 50
          description: Correlation identifier for tracking across multiple services
          example: 79389915-7275-457a-b8ca-8bf206b2e67b
        datetime:
          type: string
          format: date-time
          description: Event timestamp in UTC ISO format (e.g., 2025-12-01T12:51:41.381Z)
          example: 2025-12-01T12:51:41.381Z
        environment:
          type: string
          maxLength: 20
          description: Environment generating the event (e.g., prod, PRD-Blue)
          example: prod
        version:
          type: string
          maxLength: 10
          description: SOC JSON message format version (e.g., 1.2)
          example: "1.2"
        application:
          type: string
          maxLength: 10
          description: Application/service identifier (e.g., FCP001)
          example: FCP001
        component:
          type: string
          maxLength: 30
          description: Application component or internal name
          example: fcp-audit
        ip:
          type: string
          maxLength: 20
          description: Source IP address of the event
          example: 192.168.1.100
        security:
          type: object
          nullable: true
          description: Security event data for SOC. At least one of security or audit must be provided.
          required: [pmcode, priority]
          properties:
            pmcode:
              type: string
              maxLength: 4
              description: Protective Monitoring Code (e.g., 0706)
              example: "0706"
            priority:
              type: integer
              description: Event priority (0=normal, 5=unusual, 9=exception)
              example: 0
            details:
              type: object
              properties:
                transactioncode:
                  type: string
                  maxLength: 4
                  description: Internal transaction code within the application
                  example: "2306"
                message:
                  type: string
                  maxLength: 120
                  description: Human-readable description of the event
                  example: User successfully accessed audit record
                additionalinfo:
                  type: string
                  maxLength: 120
                  description: Additional context or information about the event
                  example: Audit event successfully processed
        audit:
          type: object
          nullable: true
          description: Audit extension fields for local retention. At least one of security or audit must be provided.
          properties:
            eventtype:
              type: string
              maxLength: 120
              description: Type of audit event (e.g., BankDetailsUpdate)
              example: AuditRecordAccess
            action:
              type: string
              maxLength: 120
              description: Action performed (e.g., UPDATE_BANK_DETAILS)
              example: VIEW_AUDIT_RECORD
            entity:
              type: string
              maxLength: 120
              description: Entity being audited (e.g., BankDetails)
              example: AuditRecord
            entityid:
              type: string
              maxLength: 120
              description: Unique identifier for the entity
              example: AUD-79389915
            status:
              type: string
              maxLength: 120
              description: Status of the action (e.g., SUCCESS, FAILURE)
              example: SUCCESS
            details:
              type: object
              additionalProperties: true
              description: Additional audit details (e.g., caseid)
              example:
                caseid: CRM-09384721
      description: |
        At least one of 'security' or 'audit' must be provided and not null.
        If only security is provided, the event is sent to SOC only.
        If only audit is provided, the event is saved to the audit database only.
        If both are provided, the event is sent to SOC and saved to the audit database.
