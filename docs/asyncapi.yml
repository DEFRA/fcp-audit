asyncapi: 3.0.0
info:
  title: FCP Farming Data Model (FDM) - Event API
  version: 0.1.0
  description: |
    The FDM service consumes audit events from FCP services via AWS SQS.

    Events are either forwarded to the Security Operations Centre (SOC) for security monitoring,
    or stored in the audit database for future analysis.
  license:
    name: Open Government Licence v3.0
    url: https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3

defaultContentType: application/json

servers:
  development:
    host: localhost:4566
    protocol: sqs
    description: LocalStack SQS for development
    bindings:
      sqs:
        region: eu-west-2
        queueName: fcp_audit
        deadLetterQueue:
          name: fcp_audit-deadletter
          maxReceiveCount: 3

channels:
  eventQueue:
    address: fcp_audit
    description: Main event queue for FCP Audit events to be processed by the Auditing service.
    messages:
      auditEvent:
        $ref: '#/components/messages/AuditEvent'

operations:
  consumeEvents:
    action: receive
    channel:
      $ref: '#/channels/eventQueue'
    description: |
      Consume and process audit events from the SQS queue. Events are validated,
      stored in the audit collection and optionally published to SOC.
    messages:
      - $ref: '#/channels/eventQueue/messages/auditEvent'

components:
  messages:
    AuditEvent:
      name: AuditEvent
      title: Audit Event
      description: Audit event received by the Auditing service.
      contentType: application/json
      payload:
        $ref: '#/components/schemas/AuditEventPayload'

  schemas:
    AuditEventPayload:
      type: object
      required:
        - correlationid
        - datetime
        - environment
        - version
        - application
        - component
      properties:
        user:
          type: string
          maxLength: 50
          description: |
            User account triggering the event. One of:
            - IDM/contactId - Defra ID
            - AAD/userId - Entra
            Not required if activity is not related to a user session (e.g., scheduled task or system trigger).
          example: IDM/8b7c6b0a-4ea2-e911-a971-000d3a28d1a0
        sessionid:
          type: string
          maxLength: 50
          description: |
            Session identifier associated with the user. One of:
            - sessionId property from JWT - Defra ID
            - sid property from JWT - Entra
            Not required if activity is not related to a user session (e.g., scheduled task or system trigger).
          example: e66d78f5-a58d-46f6-a9b4-f8c90e99b6dc
        correlationid:
          type: string
          maxLength: 50
          description: |
            How event can be traced across user journey. For transactions end to end hosted on CDP, 
            this should be the value of the x-cdp-request-id HTTP header. Where the request involves 
            an asynchronous API such as SQS, the provider service should ensure this value is passed 
            as a correlationid property downstream to allow the full transaction to be audited downstream.
          example: 79389915-7275-457a-b8ca-8bf206b2e67b
        datetime:
          type: string
          format: date-time
          description: UTC ISO 8601 timestamp when event was created
          example: 2025-12-01T12:51:41.381Z
        environment:
          type: string
          maxLength: 20
          description: |
            Environment event emitted from. Should be provided in lower case. Values include:
            - local (Local development)
            - cdp-dev, cdp-test, cdp-perf-test, cdp-ext-test, cdp-prod (CDP)
            - fcp-dev, fcp-test, fcp-preprod, fcp-prod (FCP Platform)
            The value is automatically converted to lowercase by the service.
          example: fcp-prod
        version:
          type: string
          maxLength: 10
          description: |
            Version of SOC event schema the event conforms to. This can be taken from the AsyncAPI spec document. 
            Until version 1.0.0 is published, the schema should be considered a volatile work in progress. 
            The Audit service will only support the latest version.
          example: "0.1.0"
        application:
          type: string
          maxLength: 30
          description: GIO code referring to the source system (e.g., Single Front Door)
          example: FCP001
        component:
          type: string
          maxLength: 30
          description: Specific component or microservice of the source system. Typically this would align to the CDP service name and GitHub repository.
          example: fcp-sfd-frontend
        ip:
          type: string
          maxLength: 20
          description: |
            IP address the request originated from. Rules:
            - If the service is a backend API, the IP should relate to the frontend or other service the request came from.
            - If the service is a frontend service, the IP should relate to the user's IP and not any infrastructure gateway IPs.
            - If request originates from within the service itself (scheduled task/system trigger), then the self host IP should be provided.
            Optional field.
          example: 192.168.1.100
        security:
          type: object
          nullable: true
          description: |
            Object containing security event data. If present, event data will be sent to SOC. 
            At least one of security or audit must be provided.
          required:
            - pmcode
          properties:
            pmcode:
              type: string
              maxLength: 4
              description: |
                SOC event code most relevant to event. Should be 4 digits. If dashes are provided (e.g., 02-01), 
                the Audit service will automatically remove them before they are sent to the SOC. 
                See SOC documentation for full list of existing event codes.
              example: "0201"
            priority:
              type: integer
              minimum: 0
              maximum: 9
              default: 0
              description: |
                Number from 0-9 indicating rareness of event:
                - 0 = normal event
                - 5 = unusual event
                - 9 = exception event
                If not provided, will default to 0.
              example: 0
            details:
              type: object
              description: Object containing context-specific security details
              properties:
                transactioncode:
                  type: string
                  maxLength: 4
                  description: Context specific event code. Naming convention should be agreed with SOC team if SOC ruleset required.
                  example: "2306"
                message:
                  type: string
                  maxLength: 120
                  description: String containing additional context
                  example: User successfully accessed audit record
                additionalinfo:
                  type: string
                  maxLength: 120
                  description: String containing additional context specific properties (must be string, not JSON)
                  example: Audit event successfully processed
        audit:
          type: object
          nullable: true
          description: |
            Object containing audit data. If present, data will be persisted within the Audit service for future analysis. 
            At least one of security or audit must be provided.
          required:
            - eventtype
          properties:
            eventtype:
              type: string
              maxLength: 120
              description: |
                Context specific event type. This is the minimum data to be persisted for future analysis.
              example: BankDetailsUpdate
            action:
              type: string
              maxLength: 120
              description: |
                Specific action performed. Typically one of:
                - create
                - read
                - update
                - delete
              example: update
            entity:
              type: string
              maxLength: 120
              description: Description of the entity being audited (e.g., Bank Details)
              example: Bank Details
            entityid:
              type: string
              maxLength: 120
              description: Identifier of entity being updated. This could be a primary key, unique reference, etc.
              example: AUD-79389915
            status:
              type: string
              maxLength: 120
              description: |
                Status of event. Typically one of:
                - success
                - failure
              example: success
            details:
              type: object
              additionalProperties: true
              description: Object containing context specific additional auditing data to be queried (e.g., caseid for CRM case IDs)
              example:
                caseid: CRM-09384721
      description: |
        At least one of 'security' or 'audit' must be provided and not null.
        If only security is provided, the event is sent to SOC only.
        If only audit is provided, the event is saved to the audit database only.
        If both are provided, the event is sent to SOC and saved to the audit database.
